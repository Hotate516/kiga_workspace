## KigaNote アプリケーション仕様書

### 1. 概要

KigaNoteは、Googleドキュメントに類似したリッチテキストエディタを目指して開発されています。ユーザーはテキストの書式設定、リンク、画像の挿入などが可能なドキュメントを作成・編集し、Firebaseを介してデータを永続化できます。

### 2. 使用技術スタック

*   **フロントエンド**: Next.js (React), Tailwind CSS
*   **リッチテキストエディタ**: Tiptap
*   **状態管理**: Zustand (`useUserStore`)
*   **バックエンド/データベース**: Firebase Authentication, Firestore (ノートのメタデータ), Firebase Storage (ノートのコンテンツ)
*   **ユーティリティ**: `react-hot-toast` (トースト通知), `uuid` (ID生成)

### 3. 主要機能

#### 3.1. リッチテキストエディタ機能

*   **基盤**: Tiptapエディタを使用。
*   **サポートされる書式設定**:
    *   基本的な書式設定 (太字、斜体、見出しなど) - `StarterKit`
    *   下線 - `Underline`
    *   プレースホルダーテキスト ("ここに入力してください...") - `Placeholder`
    *   リンクの挿入、自動リンク、ペースト時のリンク検出 - `LinkExtension`
    *   画像の挿入 (画像アップロード機能は明示的に実装されていないが、Tiptapの`ImageExtension`はサポート) - `ImageExtension`
    *   テキストスタイル、色の変更 - `TextStyle`, `Color`
    *   マルチカラー対応のテキストハイライト - `Highlight`
    *   タイポグラフィの強化 - `Typography`
*   **コンテンツ形式**: TiptapのJSON形式でコンテンツを管理。

#### 3.2. ノート管理機能

*   **ノートの作成 (`handleCreateNewPage`)**:
    *   新しいUUIDを生成し、ノートIDとして使用。
    *   初期タイトルは「無題のページ」。
    *   Firestoreにノートのメタデータ (ID, タイトル, 最終更新日時) を保存。
    *   Firebase Storageにノートの初期コンテンツ (空のJSON) を保存。
    *   ローカルストレージにタイトルとコンテンツJSONをキャッシュ。
    *   新しいノート作成後、自動的にそのノートを選択。
    *   ユーザーがノートを一つも持っていない場合、初回起動時に自動的にノートを作成。
*   **ノートの読み込み (`loadNoteData`)**:
    *   ユーザーがノートを選択すると、そのノートのデータを読み込む。
    *   まずローカルストレージからタイトルとコンテンツJSONのキャッシュを試みる。
    *   ローカルキャッシュが存在しない、またはパースに失敗した場合、Firebase StorageからコンテンツJSONをフェッチ。
    *   Firestoreからノートのメタデータ (タイトルなど) を取得。
    *   読み込み中はエディタを無効化し、読み込み完了後に有効化。
*   **ノートの保存 (`handleSaveToFirebase`)**:
    *   現在のエディタのコンテンツ (JSON形式) をFirebase Storageに保存。
    *   現在のタイトルと最終更新日時をFirestoreのノートメタデータに更新。
    *   タイトルやエディタ内容の変更時に、メタデータの更新をデバウンス (`debounceUpdateFirestoreMeta`) してFirestoreへの書き込み頻度を抑制。
    *   明示的な保存ボタンのクリックが必要。
*   **ノートの削除 (`handleDeleteNote`)**:
    *   ユーザーが選択したノートを削除。
    *   Firestoreからノートのメタデータを削除。
    *   Firebase Storageからノートのコンテンツファイルを削除 (ファイルが存在しない場合は警告のみ)。
    *   ローカルストレージのキャッシュも削除。
    *   ユーザーに確認プロンプトを表示。
    *   残りのノートが1つ以下の場合、削除を禁止。
    *   削除後、自動的に別のノートを選択（存在する場合）。
*   **ノートの一覧表示 (`fetchNotesList`)**:
    *   Firestoreからユーザーの全てのノートメタデータを取得し、最終更新日時で降順にソートして表示。
    *   サイドバーにノートのリストを表示し、クリックで選択可能。
    *   最後に開いたノートをローカルストレージから記憶し、次回起動時に自動的に読み込む。

#### 3.3. ユーザーインターフェース (UI)

*   **レイアウト**: サイドバー、メインエディタ領域、右サイドバー (アイコンのみ) の3カラム構成。
*   **サイドバー (左)**:
    *   Kiga Workspaceのロゴとナビゲーションリンク (ダッシュボード)。
    *   KigaNoteセクションにノートリストを表示。
    *   「＋ 新規ページ作成」ボタン。
    *   「アプリ一覧へ」ボタン (ダッシュボードのセクションへスクロール)。
*   **メインエディタ領域**:
    *   ノートのタイトル入力フィールド。
    *   「保存」ボタンと「削除」ボタン。
    *   最終保存日時を表示。
    *   Tiptapエディタのツールバー (`Toolbar` コンポーネントを使用)。
    *   Tiptapエディタコンテンツ表示領域。
    *   読み込み中、保存中、削除中のステータス表示。
    *   ノートがない場合の「最初のノートを作成する」ボタン表示。
*   **右サイドバー**:
    *   通知アイコン (`BellIcon`)。
    *   ユーザープロフィールアイコン (クリックでプロフィールページへ遷移)。
*   **通知**: `react-hot-toast` を使用したトースト通知で、保存、作成、削除の成功/失敗をユーザーにフィードバック。
*   **未ログイン状態**: ログインしていないユーザーには、ログインを促すメッセージと、エディタ機能の無効化。

### 4. データ永続化

*   **Firestore**:
    *   パス: `users/{uid}/kigaNotes/{noteId}`
    *   データ: `title` (ノートのタイトル), `lastModified` (最終更新日時 - `Timestamp`型)
*   **Firebase Storage**:
    *   パス: `kigaNotes/{uid}/{noteId}.json`
    *   データ: Tiptapエディタのコンテンツ (JSON文字列)
*   **Local Storage**:
    *   `kigaNote_{uid}_{noteId}_title`: ノートのタイトルキャッシュ
    *   `kigaNote_{uid}_{noteId}_content_json`: ノートのコンテンツJSONキャッシュ
    *   `kigaNote_{uid}_lastOpened`: 最後に開いたノートのID
